---
name: CI

permissions:
  contents: read
  packages: write

'on':
  push: {}
  pull_request: {}

jobs:
  validate:
    name: Validate workflow YAML
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install PyYAML
        run: python -m pip install --user pyyaml

      - name: Validate workflows
        run: |
          python - <<'PY'
          import yaml,sys,glob
          ok=True
          for p in glob.glob('.github/workflows/*.yml'):
              try:
                  yaml.safe_load(open(p))
                  print(p, 'OK')
              except Exception as e:
                  print(p, 'ERROR', e)
                  ok=False
          if not ok:
              sys.exit(1)
          print('All workflow YAML parsed successfully')
          PY

  determine-changed:
    name: Determine changed services
    runs-on: ubuntu-latest
    outputs:
      services: ${{ steps.set.outputs.services }}
    steps:
      - uses: actions/checkout@v4

      - name: Determine changed services
        id: set
        run: |
          git fetch origin main --depth=1 || true
          CHANGED_FILES=$(git diff --name-only origin/main...HEAD || true)
          echo "Changed files: $CHANGED_FILES"
          SERVICES_LIST=()
          CHECK_DIRS=(
            auth
            admin-service
            order
            food-delivery-server
            payment-service
            notification-service
            restaurant
          )
          for d in "${CHECK_DIRS[@]}"; do
            if echo "$CHANGED_FILES" | grep -q "^$d/"; then
              SERVICES_LIST+=("$d")
            fi
          done
          if [ ${#SERVICES_LIST[@]} -eq 0 ]; then
            SERVICES_LIST=("${CHECK_DIRS[@]}")
          fi
          ARR=""
          for s in "${SERVICES_LIST[@]}"; do
            if [ -z "$ARR" ]; then ARR="\"$s\""; else ARR="$ARR,\"$s\""; fi
          done
          JSON="[$ARR]"
          echo "services=$JSON" >> $GITHUB_OUTPUT

  unit-tests:
    name: Run unit tests for changed services
    runs-on: ubuntu-latest
    needs: determine-changed
    steps:
      - uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Run tests for changed services
        id: run-tests
        env:
          SERVICES_JSON: ${{ needs.determine-changed.outputs.services }}
        run: |
          set -euo pipefail
          echo "Services JSON: $SERVICES_JSON"
          if [ -z "$SERVICES_JSON" ] || [ "$SERVICES_JSON" = '[]' ]; then
            echo "No changed services; skipping unit-tests"
            exit 0
          fi
          mkdir -p test-reports
          for svc in $(echo "$SERVICES_JSON" | jq -r '.[]'); do
            # Only run tests if package.json exists and has a test script
            if [ -f "$svc/package.json" ]; then
              echo "Checking $svc for tests"
              if grep -q '"test"' "$svc/package.json"; then
                echo "Running tests for $svc"
                pushd $svc
                npm ci --silent
                # Run tests and output JSON to reports for upload
                npm test -- --json --outputFile=../test-reports/${svc//\//-}-jest.json || true
                popd
              else
                echo "No test script in $svc/package.json; skipping"
              fi
            else
              echo "No package.json in $svc; skipping"
            fi
          done

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-reports
          path: test-reports


  build-images:
    name: Build images
    runs-on: ubuntu-latest
    needs: determine-changed
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Check GHCR cache
        id: cache-check
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          set -e
          AUTH=${GHCR_PAT:-$GITHUB_TOKEN}
          if [ -z "$AUTH" ]; then
            echo "No registry credentials available; assuming no cache" >> /dev/stderr
            echo "cache_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          status=$(curl -s -o /dev/null -w "%{http_code}" \
            -u "${GITHUB_ACTOR}:${AUTH}" \
            "https://ghcr.io/v2/${REPO_OWNER}/cnpm-build-cache/manifests/cache" || echo "000")
          if [ "$status" = "200" ]; then
            echo "cache_exists=true" >> $GITHUB_OUTPUT
          else
            echo "cache_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Build changed service images
        env:
          SERVICES_JSON: ${{ needs.determine-changed.outputs.services }}
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CACHE_EXISTS: ${{ steps.cache-check.outputs.cache_exists }}
        run: |
          set -euo pipefail
          echo "Services JSON: $SERVICES_JSON"
          if [ -z "$SERVICES_JSON" ] || [ "$SERVICES_JSON" = '[]' ]; then
            echo "No services to build"
            exit 0
          fi
          if [ -n "$GHCR_PAT" ] || [ -n "$GITHUB_TOKEN" ]; then
            echo "Credentials present - will push to GHCR and use registry cache"
            echo "${GHCR_PAT:-$GITHUB_TOKEN}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            owner_lower=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1 | tr '[:upper:]' '[:lower:]')
            CACHE_REPO=${CACHE_REPO:-ghcr.io/${owner_lower}/cnpm-build-cache}
            echo "Using cache repo: ${CACHE_REPO}"
            for svc in $(echo "$SERVICES_JSON" | jq -r '.[]'); do
              safe_svc=${svc//\//-}
              gh_image=ghcr.io/${owner_lower}/cnpm-${safe_svc}:sha-${GITHUB_SHA}
              echo "Building and pushing $svc -> $gh_image"
              cache_flags=()
              if [ "${CACHE_EXISTS:-false}" = "true" ] && [ -n "${CACHE_REPO}" ]; then
                echo "Registry cache exists; using cache flags"
                cache_flags=(
                  --cache-from=type=registry,ref=${CACHE_REPO}:cache
                  --cache-to=type=registry,ref=${CACHE_REPO}:cache,mode=max
                )
              else
                echo "Registry cache missing or unavailable; building without registry cache"
              fi
              docker buildx build \
                --push \
                --tag ${gh_image} \
                "${cache_flags[@]}" \
                ./$svc
              docker pull ${gh_image}
              docker tag ${gh_image} ci-${safe_svc}:latest
            done
          else
            echo "No GHCR credentials found — building images locally and loading into docker"
            for svc in $(echo "$SERVICES_JSON" | jq -r '.[]'); do
              safe_svc=${svc//\//-}
              echo "Building local image ci-${safe_svc}:latest from ./$svc"
              docker buildx build --load --tag ci-${safe_svc}:latest ./$svc
            done
          fi

  service-smoke-tests:
    name: Service smoke tests
    runs-on: ubuntu-latest
    needs: [determine-changed, build-images]
    steps:
      - uses: actions/checkout@v4

      - name: Optionally set GHCR credentials env
        env:
          GHCR_PAT: ${{ secrets.GHCR_PAT }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "GHCR_PAT present: ${GHCR_PAT:+yes}"
          echo "GITHUB_TOKEN present: ${GITHUB_TOKEN:+yes}"

      - name: Install jq and curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Run smoke tests for changed services
        env:
          SERVICES_JSON: ${{ needs.determine-changed.outputs.services }}
        run: |
          set -euo pipefail
          echo "Services JSON: $SERVICES_JSON"
          if [ -z "$SERVICES_JSON" ] || [ "$SERVICES_JSON" = '[]' ]; then
            echo "No changed services; skipping smoke-tests"
            exit 0
          fi
          docker network create ci-net || true
          docker run -d --name ci-mongo --network ci-net mongo:6
          sleep 5
          declare -A PORT_MAP
          PORT_MAP=(
            ["auth-service"]=5001
            ["order-service"]=5002
            ["delivery-service"]=5004
            ["payment-service"]=5005
            ["notification-service"]=5007
            ["restaurant"]=5006
          )
          for svc in $(echo "$SERVICES_JSON" | jq -r '.[]'); do
            safe_svc=${svc//\//-}
            port=${PORT_MAP[$svc]:-}
            if [ -z "$port" ]; then
              echo "No port mapping for $svc; skipping"
              continue
            fi
            # Prefer local ci-<service>:latest image if exists
            if docker image inspect ci-${safe_svc}:latest >/dev/null 2>&1; then
              gh_image=ci-${safe_svc}:latest
            else
              owner_lower=$(echo "$GITHUB_REPOSITORY" | cut -d'/' -f1 | tr '[:upper:]' '[:lower:]')
              gh_image=ghcr.io/${owner_lower}/cnpm-${safe_svc}:sha-${GITHUB_SHA}
              echo "Attempting to pull $gh_image from GHCR"
                if ! docker pull $gh_image; then
                echo "Failed to pull $gh_image, trying :latest"
                gh_image=ghcr.io/${owner_lower}/cnpm-${safe_svc}:latest
                if ! docker pull $gh_image; then
                  echo "No image available for $svc; skipping"
                  continue
                fi
              fi
            fi
            echo "Running $svc on port $port"
            env_args=""
            case "$svc" in
              auth|auth-service)
                env_args="-e PORT=$port -e MONGO_URI=mongodb://ci-mongo:27017/auth_test"
                ;;
              order|order-service)
                env_args="-e PORT=$port -e MONGODB_URI=mongodb://ci-mongo:27017/order_test"
                ;;
              delivery|delivery-service)
                env_args="-e PORT=$port -e DELIVERY_MONGO_URI=mongodb://ci-mongo:27017/delivery_test"
                ;;
              payment|payment-service)
                env_args="-e PORT=$port -e MONGO_URI=mongodb://ci-mongo:27017/payment_test"
                ;;
              notification|notification-service)
                env_args="-e PORT=$port -e MONGO_URI=mongodb://ci-mongo:27017/notifications_test -e ENABLE_KAFKA=false"
                ;;
              restaurant)
                env_args="-e PORT=$port -e MONGOURL=mongodb://ci-mongo:27017/restaurant_test"
                ;;
              *)
                env_args="-e PORT=$port -e MONGO_URI=mongodb://ci-mongo:27017/test"
                ;;
            esac
            docker run -d --name ci-${safe_svc} --network ci-net \
              -p ${port}:${port} $env_args $gh_image \
              || (echo "Failed to start $svc" && exit 1)
            ok=0
            for i in $(seq 1 12); do
              if curl -sS --max-time 2 http://localhost:${port}/metrics >/dev/null 2>&1; then ok=1; break; fi
              if curl -sS --max-time 2 http://localhost:${port}/health >/dev/null 2>&1; then ok=1; break; fi
              if curl -sS --max-time 2 http://localhost:${port}/ >/dev/null 2>&1; then ok=1; break; fi
              sleep 2
            done
            if [ $ok -ne 1 ]; then
              docker logs ci-${safe_svc} --tail 200 || true
              echo "Service $svc failed startup checks" && exit 1
            fi
            echo "$svc is healthy"
          done
          echo "All tested services are healthy"

      - name: Cleanup containers and network
        run: |
          set -e || true
          docker ps -aq | xargs -r docker rm -f || true
          docker network rm ci-net || true
