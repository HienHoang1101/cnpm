---
name: CI/CD Pipeline

'on':
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
  IMAGE_NAMESPACE: ${{ secrets.DOCKER_USERNAME }}

jobs:
  lint:
    name: Lint (Super-Linter)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Super-Linter
        uses: github/super-linter@v4
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false
          FILTER_REGEX_EXCLUDE: >-
            (^|/)(node_modules|vendor|dist|build|coverage|.git)/

  unit-tests:
    name: Unit tests
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: monitoring
            path: monitoring
          - name: order
            path: order
          - name: auth
            path: auth
          - name: admin-service
            path: admin-service
          - name: payment-service
            path: payment-service
          - name: notification-service
            path: notification-service
          - name: restaurant
            path: restaurant
          - name: food-delivery-server
            path: food-delivery-server
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        working-directory: ${{ matrix.path }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
      - name: Run unit tests (skip if missing)
        working-directory: ${{ matrix.path }}
        run: |
          if node - <<'NODE'
            const p = require('./package.json');
            if (p.scripts && p.scripts.test) process.exit(0);
            process.exit(1);
          NODE
          then
            npm test
          else
            echo "No test script for ${{ matrix.name }}, skipping."
          fi

  integration-tests:
    name: Integration tests
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: monitoring
            path: monitoring
          - name: order
            path: order
          - name: auth
            path: auth
          - name: admin-service
            path: admin-service
          - name: payment-service
            path: payment-service
          - name: notification-service
            path: notification-service
          - name: restaurant
            path: restaurant
          - name: food-delivery-server
            path: food-delivery-server
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      - name: Install dependencies
        working-directory: ${{ matrix.path }}
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi
      - name: Run integration tests (skip if missing)
        working-directory: ${{ matrix.path }}
        run: |
          if node - <<'NODE'
            const p = require('./package.json');
            if (p.scripts && p.scripts['test:integration']) process.exit(0);
            process.exit(1);
          NODE
          then
            npm run test:integration
          else
            echo "No integration test script for ${{ matrix.name }}, skipping."
          fi

  security-scan:
    name: Security scan (Trivy)
    runs-on: ubuntu-latest
    needs: [lint, unit-tests]
    steps:
      - uses: actions/checkout@v4
      - name: Run Trivy FS scan
        uses: aquasecurity/trivy-action@0.20.0
        with:
          scan-type: fs
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          exit-code: '1'
          format: table

  docker-build-push:
    name: Build and push images
    runs-on: ubuntu-latest
    needs: [lint, unit-tests, integration-tests, security-scan]
    env:
      TAG_BASE: ${{ secrets.DOCKER_REGISTRY }}/${{ secrets.DOCKER_USERNAME }}
    strategy:
      fail-fast: false
      matrix:
        service:
          - auth
          - admin-service
          - payment-service
          - notification-service
          - restaurant
          - food-delivery-server
          - order
    steps:
      - uses: actions/checkout@v4
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Verify registry secrets
        run: |
          if [ -z "${{ secrets.DOCKER_REGISTRY }}" ] || \
             [ -z "${{ secrets.DOCKER_USERNAME }}" ] || \
             [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "Docker registry secrets missing"
            exit 1
          fi
      - name: Login to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.DOCKER_REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.service }}
          push: true
          tags: |
            ${{ env.TAG_BASE }}/${{ matrix.service }}:latest
            ${{ env.TAG_BASE }}/${{ matrix.service }}:${{ github.sha }}

  deploy:
    name: Deploy to cluster
    runs-on: ubuntu-latest
    needs: docker-build-push
    if: >-
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.28.0
      - name: Configure kubeconfig
        if: ${{ secrets.DEPLOY_ENABLED == 'true' }}
        env:
          KUBE_CONFIG_CONTENT: ${{ secrets.KUBE_CONFIG }}
        run: |
          mkdir -p ~/.kube
          tmp="$(mktemp)"
          decode_base64() {
            echo "$1" | base64 -d 2>/dev/null || return 1
          }
          is_kubeconfig() {
            echo "$1" | grep -q "apiVersion:.*v1" && \
            echo "$1" | grep -q "kind: Config" >/dev/null 2>&1
          }
          # 1) try base64 decode once
          if decoded="$(decode_base64 "$KUBE_CONFIG_CONTENT")" && \
             is_kubeconfig "$decoded"; then
            echo "$decoded" > "$tmp"
          # 2) try plain content
          elif is_kubeconfig "$KUBE_CONFIG_CONTENT"; then
            echo "$KUBE_CONFIG_CONTENT" > "$tmp"
          else
            echo "KUBE_CONFIG secret is not a valid kubeconfig."
            exit 1
          fi
          mv "$tmp" ~/.kube/config
      - name: Deploy with kustomize overlays
        if: ${{ secrets.DEPLOY_ENABLED == 'true' }}
        run: |
          kubectl apply -k kubernetes

  notify:
    name: Notify (Telegram)
    runs-on: ubuntu-latest
    needs:
      - lint
      - unit-tests
      - integration-tests
      - security-scan
      - docker-build-push
      - deploy
    if: always()
    steps:
      - name: Send Telegram notification
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_CHAT_ID }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: |
            CI/CD Pipeline Report
            Repository: ${{ github.repository }}
            Commit: ${{ github.sha }}
            Actor: ${{ github.actor }}

            Lint: ${{ needs.lint.result }}
            Unit tests: ${{ needs.unit-tests.result }}
            Integration tests: ${{ needs.integration-tests.result }}
            Security scan: ${{ needs.security-scan.result }}
            Build & push: ${{ needs.docker-build-push.result }}
            Deploy: ${{ needs.deploy.result }}
